generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  DISTRICT_ADMIN
  SCHOOL_ADMIN
  TEACHER
  PARENT
}

enum SchoolType {
  GOVT
  PRIVATE
}

enum DistrictReportType {
  WATER
  VECTOR
  HEAT
  AIR
  SANITATION
}

enum DistrictAlertType {
  HEAT
  AIR
  WATER
  VECTOR
  SANITATION
}

enum DistrictAlertStatus {
  ACTIVE
  RESOLVED
  WATCH
}

enum DistrictResourceActionType {
  INSPECTION
  WATER_TESTING
  FUMIGATION
}

enum DistrictResourceStatus {
  RECOMMENDED
  SCHEDULED
  COMPLETED
}

model User {
  id           String       @id @default(uuid())
  name         String
  email        String       @unique
  passwordHash String       @map("password_hash")
  role         UserRole
  schoolId     String?      @map("school_id")
  childStudentId String?    @map("child_student_id")
  createdAt    DateTime     @default(now()) @map("created_at")
  school       School?      @relation(fields: [schoolId], references: [id])
  childStudent Student?     @relation("ParentChild", fields: [childStudentId], references: [id])
  refreshTokens RefreshToken[]
  camps        HealthCamp[] @relation("CampCreator")
  audits       AuditLog[]
  districtReports DistrictReportSnapshot[]

  @@index([childStudentId])
  @@map("users")
}

model School {
  id         String      @id @default(uuid())
  name       String
  udiseCode  String      @unique @map("udise_code")
  type       SchoolType
  district   String
  infraScore Float       @map("infra_score")
  createdAt  DateTime    @default(now()) @map("created_at")
  users      User[]
  students   Student[]
  camps      HealthCamp[]
  geoProfile SchoolGeoProfile?

  @@index([district])
  @@map("schools")
}

model SchoolGeoProfile {
  id        String   @id @default(uuid())
  schoolId  String   @unique @map("school_id")
  latitude  Float
  longitude Float
  blockName String   @map("block_name")
  wardName  String   @map("ward_name")
  createdAt DateTime @default(now()) @map("created_at")
  school    School   @relation(fields: [schoolId], references: [id])

  @@index([blockName])
  @@map("school_geo_profiles")
}

model Student {
  id                String            @id @default(uuid())
  schoolId          String            @map("school_id")
  className         String            @map("class")
  gender            String
  heightCm          Float             @map("height_cm")
  weightKg          Float             @map("weight_kg")
  bmi               Float
  vaccinationStatus String            @map("vaccination_status")
  attendanceRatio   Float             @default(1) @map("attendance_ratio")
  riskScore         Float             @default(0) @map("risk_score")
  createdAt         DateTime          @default(now()) @map("created_at")
  school            School            @relation(fields: [schoolId], references: [id])
  schemeEligibility SchemeEligibility?
  parentUsers       User[]            @relation("ParentChild")

  @@index([schoolId])
  @@index([riskScore])
  @@map("students")
}

model ClimateData {
  id            String   @id @default(uuid())
  district      String
  date          DateTime
  temperature   Float
  aqi           Int
  heatAlertFlag Boolean  @default(false) @map("heat_alert_flag")

  @@index([district])
  @@index([date])
  @@map("climate_data")
}

model DistrictFieldReport {
  id         String             @id @default(uuid())
  district   String
  blockName  String             @map("block_name")
  reportType DistrictReportType @map("report_type")
  severity   Int
  reportedAt DateTime           @default(now()) @map("reported_at")
  sourceRole UserRole           @map("source_role")

  @@index([district])
  @@index([reportedAt])
  @@index([blockName])
  @@map("district_field_reports")
}

model DistrictEnvironmentalAlert {
  id        String              @id @default(uuid())
  district  String
  alertType DistrictAlertType   @map("alert_type")
  severity  Int
  startsAt  DateTime            @map("starts_at")
  endsAt    DateTime            @map("ends_at")
  status    DistrictAlertStatus @default(ACTIVE)

  @@index([district])
  @@index([status])
  @@map("district_environmental_alerts")
}

model DistrictAttendanceSignalDaily {
  id                  String   @id @default(uuid())
  district            String
  blockName           String   @map("block_name")
  date                DateTime
  schoolsReporting    Int      @map("schools_reporting")
  attendanceDropPct   Float    @map("attendance_drop_pct")
  symptomClusterIndex Float    @map("symptom_cluster_index")
  envRiskDelta        Float    @map("env_risk_delta")

  @@index([district])
  @@index([date])
  @@index([blockName])
  @@map("district_attendance_signal_daily")
}

model DistrictResourceRecommendation {
  id              String                 @id @default(uuid())
  district        String
  blockName       String                 @map("block_name")
  actionType      DistrictResourceActionType @map("action_type")
  priorityScore   Float                  @map("priority_score")
  recommendedDate DateTime               @map("recommended_date")
  status          DistrictResourceStatus  @default(RECOMMENDED)
  explanation     String
  createdAt       DateTime               @default(now()) @map("created_at")

  @@index([district])
  @@index([priorityScore])
  @@map("district_resource_recommendations")
}

model DistrictForecastMonthly {
  id        String   @id @default(uuid())
  district  String
  month     DateTime
  heatRisk  Float    @map("heat_risk")
  vectorRisk Float   @map("vector_risk")
  airRisk   Float    @map("air_risk")
  confidence Float

  @@index([district])
  @@index([month])
  @@map("district_forecast_monthly")
}

model DistrictReportSnapshot {
  id            String   @id @default(uuid())
  district      String
  generatedAt   DateTime @default(now()) @map("generated_at")
  modelVersions Json     @map("model_versions")
  summaryJson   Json     @map("summary_json")
  pdfPath       String   @map("pdf_path")
  csvPath       String   @map("csv_path")
  requestedBy   String   @map("requested_by")
  requester     User     @relation(fields: [requestedBy], references: [id])

  @@index([district])
  @@index([requestedBy])
  @@map("district_report_snapshots")
}

model SchemeEligibility {
  id               String   @id @default(uuid())
  studentId        String   @unique @map("student_id")
  ayushmanEligible Boolean  @default(false) @map("ayushman_eligible")
  rbsrFlag         Boolean  @default(false) @map("rbsr_flag")
  middayMealStatus String   @default("UNKNOWN") @map("midday_meal_status")
  updatedAt        DateTime @updatedAt @map("updated_at")
  student          Student  @relation(fields: [studentId], references: [id])

  @@map("scheme_eligibility")
}

model HealthCamp {
  id                String   @id @default(uuid())
  schoolId          String   @map("school_id")
  campType          String   @map("camp_type")
  date              DateTime
  participantsCount Int      @map("participants_count")
  createdBy         String   @map("created_by")
  school            School   @relation(fields: [schoolId], references: [id])
  creator           User     @relation("CampCreator", fields: [createdBy], references: [id])

  @@index([schoolId])
  @@map("health_camps")
}

model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @map("token_hash")
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("refresh_tokens")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  resource  String
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("audit_logs")
}
